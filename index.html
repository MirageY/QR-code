<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>批量二维码生成器</title>
  <meta name="description" content="把一批链接快速生成多个二维码，支持下载、打包、手机端访问" />
  <!-- TailwindCSS CDN（仅用于样式，页面可直接部署为静态站点） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- QR 生成库（轻量，Canvas 渲染） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <!-- 打包下载（可选）：JSZip + FileSaver 让你一键打包全部 PNG -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    .card { box-shadow: 0 10px 25px rgba(0,0,0,.08); }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-semibold">批量二维码生成器</h1>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- 控件区 -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="space-y-3">
        <label class="block text-sm font-medium">在下面粘贴链接（每行一个）</label>
        <textarea id="urls" class="w-full h-48 p-3 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="点击<示例>按钮查看样例"></textarea>
        <p class="text-xs text-gray-500">提示：会自动忽略空行；只要是有效 URL 就可以。</p>
        <p class="text-xs text-gray-500">URL上方的第一个非URL字符串会被用作二维码的提示文本。</p>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-3 gap-3 items-end">
        <label class="block">
          <span class="text-sm font-medium">尺寸（像素）</span>
          <select id="size" class="mt-1 w-full rounded-lg border p-2">
            <option value="256">256</option>
            <option value="384" selected>384</option>
            <option value="512">512</option>
            <option value="768">768</option>
          </select>
        </label>
        <label class="block">
          <span class="text-sm font-medium">纠错等级</span>
          <select id="ecl" class="mt-1 w-full rounded-lg border p-2">
            <option value="L">L（低）</option>
            <option value="M" selected>M（中）</option>
            <option value="Q">Q（较高）</option>
            <option value="H">H（高）</option>
          </select>
        </label>
        <label class="block">
          <span class="text-sm font-medium">边距（模块）</span>
          <select id="margin" class="mt-1 w-full rounded-lg border p-2">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </label>
        <label class="block col-span-2 md:col-span-3">
          <span class="text-sm font-medium">底图（可选）</span>
          <input type="file" id="bgImage" accept="image/*" class="mt-1 w-full rounded-lg border p-2 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200">
        </label>
        <div class="col-span-2 md:col-span-3 flex gap-2">
          <button id="btnGenNoBg" class="flex-1 rounded-xl bg-purple-600 text-white py-2 px-3 hover:bg-purple-700 font-medium" title="生成无底图版本">生成无底图版本</button>
        </div>
        <div class="col-span-2 md:col-span-3 flex gap-2">
          <button id="btnGen" class="flex-1 rounded-xl bg-blue-600 text-white py-2 px-3 hover:bg-blue-700 font-medium" title="生成有底图版本">生成有底图版本</button>
        </div>
        <div class="col-span-2 md:col-span-3 flex gap-2">
          <button id="btnDownloadAll" class="flex-1 rounded-xl bg-emerald-600 text-white py-2 px-3 hover:bg-emerald-400 font-medium hidden md:block" title="打包全部二维码为 ZIP">打包全部为 ZIP</button>
          <button id="btnDownloadAllMobile" class="flex-1 rounded-xl bg-emerald-600 text-white py-2 px-3 hover:bg-emerald-400 font-medium md:hidden" title="逐个下载全部二维码到相册">全部下载到相册</button>
          <button id="btnClear" class="rounded-xl bg-gray-200 text-gray-900 py-2 px-3 hover:bg-gray-300">清空</button>
          <button id="btnSample" class="rounded-xl bg-indigo-100 text-indigo-700 py-2 px-3 hover:bg-indigo-200" title="填入示例数据">示例</button>
        </div>
      </div>
    </section>

    <section class="mt-6">
      <div id="status" class="text-sm text-gray-600"></div>
      <div id="grid" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
    </section>

    <section id="howto" class="mt-12 prose max-w-none">
      <h2>关于有底图版本：默认底图池包含了10张不同的图片，每次生成都会随机选择，让每个二维码都有不同的背景。</h2>
      <ol>
        <li><strong>不上传图片</strong>：直接点击"生成有底图版本"，每个二维码会有随机的默认底图</li>
        <li><strong>上传图片</strong>：上传自己的图片后生成，所有二维码都会使用你的图片作为底图</li>
      </ol>
      <p class="text-sm text-gray-500">所有二维码在浏览器本地生成，不会上传你的链接</p>
    </section>
  </main>

  <footer class="max-w-6xl mx-auto px-4 py-8 text-xs text-gray-500">
    <p>© 批量二维码生成器</p>
  </footer>

  <script>
    const el = id => document.getElementById(id);
    const urlsEl = el('urls');
    const gridEl = el('grid');
    const statusEl = el('status');

    const pad = (n, len=2) => String(n).padStart(len, '0');
    const slug = (s, max=40) => s.replace(/https?:\/\//,'').replace(/[^a-zA-Z0-9-_\.]+/g,'-').slice(0,max).replace(/-+/g,'-');

    function parseLines(text){
      const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      const result = [];
      let currentGroup = '';

      lines.forEach(line => {
        // Check if line contains a URL
        const urlMatch = line.match(/(https?:\/\/[^\s]+)/);
        if (urlMatch) {
          // Line contains a URL
          result.push({
            url: urlMatch[1],
            group: currentGroup,
            originalLine: line
          });
        } else {
          // Try to parse as URL directly
          try {
            new URL(line);
            result.push({
              url: line,
              group: currentGroup,
              originalLine: line
            });
          } catch {
            // Not a valid URL, treat as group identifier
            currentGroup = line;
          }
        }
      });

      return result;
    }

    function loadImageFromFile(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = () => {
          URL.revokeObjectURL(url);
          resolve(img);
        };
        img.onerror = () => {
          URL.revokeObjectURL(url);
          reject(new Error('图片加载失败'));
        };
        img.src = url;
      });
    }

    function loadImageFromUrl(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('默认底图加载失败'));
        img.src = url;
      });
    }

    function getRandomDefaultImage() {
      const defaultImages = [
        // 'https://tse3.mm.bing.net/th/id/OIP.vEbZwX21fk8goQnGSFTjMgHaEk?r=0&rs=1&pid=ImgDetMain&o=7&rm=3',
        'https://raw.githubusercontent.com/MirageY/QR-code/main/pics/00.jpg',
        'https://raw.githubusercontent.com/MirageY/QR-code/main/pics/01.jpg',
        'https://raw.githubusercontent.com/MirageY/QR-code/main/pics/02.jpg',
        'https://raw.githubusercontent.com/MirageY/QR-code/main/pics/03.jpg',
        'https://raw.githubusercontent.com/MirageY/QR-code/main/pics/04.jpg',
        'https://raw.githubusercontent.com/MirageY/QR-code/main/pics/05.jpg',
        'https://raw.githubusercontent.com/MirageY/QR-code/main/pics/06.jpg',
        'https://raw.githubusercontent.com/MirageY/QR-code/main/pics/07.jpg',
        'https://raw.githubusercontent.com/MirageY/QR-code/main/pics/08.jpg',
        'https://raw.githubusercontent.com/MirageY/QR-code/main/pics/09.jpg',
      ];
      return defaultImages[Math.floor(Math.random() * defaultImages.length)];
    }

    async function makeQRCanvas(value, { size=384, margin=2, ecl='M', backgroundImage=null, index=1, label=null, noBg=false }={}){
      // Check if QRious library is available
      if (typeof QRious === 'undefined') {
        throw new Error('QRious library not loaded');
      }
      
      // If no background image or noBg flag is true, create QR with logo in center
      if (!backgroundImage || noBg) {
        const qrCanvas = document.createElement('canvas');
        const qr = new QRious({
          element: qrCanvas,
          value: value,
          size: size,
          level: ecl
        });
        
        // If noBg is true, add logo in center and text below
        if (noBg) {
          const borderWidth = 10;
          const textHeight = 20;
          const totalHeight = size + borderWidth * 2 + textHeight;
          const totalWidth = size + borderWidth * 2;
          
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = totalWidth;
          canvas.height = totalHeight;
          
          // Fill with white background
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, totalWidth, totalHeight);
          
          // Draw the QR code with border offset
          ctx.drawImage(qrCanvas, borderWidth, borderWidth);
          
          // Draw logo in the center
          try {
            const logoImg = await loadImageFromUrl('https://raw.githubusercontent.com/MirageY/QR-code/main/logo1.png');
            
            // Logo size is 1/4th of QR code size
            const logoSize = size / 4;
            const logoX = borderWidth + (size - logoSize) / 2;
            const logoY = borderWidth + (size - logoSize) / 2;
            
            // Draw white background circle for logo
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(logoX + logoSize/2, logoY + logoSize/2, logoSize/2 + 4, 0, 2 * Math.PI);
            ctx.fill();
            
            // Draw logo
            ctx.drawImage(logoImg, logoX, logoY, logoSize, logoSize);
          } catch (e) {
            // If logo fails to load, continue without it
            console.warn('Logo failed to load:', e);
          }
          
          // Draw text below QR code
          ctx.fillStyle = 'black';
          ctx.font = '24px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(
            label || `#${String(index).padStart(2, '0')}`, 
            totalWidth / 2, 
            size + borderWidth * 2 + 14
          );
          
          return canvas;
        }
        
        return qrCanvas;
      }

      // Calculate enlarged background size (3x larger to make QR 1/9th)
      const scaleFactor = 1;
      const enlargedWidth = backgroundImage.width * scaleFactor;
      const enlargedHeight = backgroundImage.height * scaleFactor;
      
      // QR code size is 1/9th of the enlarged background (1/3 width * 1/3 height = 1/9)
      const qrSize = Math.min(enlargedWidth, enlargedHeight) / 4;
      
      // Create QR code canvas with calculated size
      const qrCanvas = document.createElement('canvas');
      const qr = new QRious({
        element: qrCanvas,
        value: value,
        size: qrSize,
        level: ecl
      });

      // Create composite canvas
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Set canvas size to enlarged background size
      canvas.width = enlargedWidth;
      canvas.height = enlargedHeight;
      
      // Draw enlarged background image
      ctx.drawImage(backgroundImage, 0, 0, enlargedWidth, enlargedHeight);
      
      // Calculate padding for white border and text
      const borderWidth = 10;
      const textHeight = 20;
      const totalQRHeight = qrSize + borderWidth * 2 + textHeight;
      const totalQRWidth = qrSize + borderWidth * 2;
      
      // Calculate random position avoiding center area (3x3 grid, avoid middle block)
      const maxX = enlargedWidth - totalQRWidth;
      const maxY = enlargedHeight - totalQRHeight;

      // Define center area to avoid (middle 1/3 of both width and height)
      const centerStartX = enlargedWidth / 3;
      const centerEndX = (enlargedWidth * 2) / 3;
      const centerStartY = enlargedHeight / 3;
      const centerEndY = (enlargedHeight * 2) / 3;

      let randomX, randomY;
      let attempts = 0;
      const maxAttempts = 100;

      do {
        randomX = Math.floor(Math.random() * (maxX + 1));
        randomY = Math.floor(Math.random() * (maxY + 1));
        attempts++;

        // Check if QR code overlaps with center area
        const qrEndX = randomX + totalQRWidth;
        const qrEndY = randomY + totalQRHeight;

        const overlapsCenter = !(qrEndX <= centerStartX || randomX >= centerEndX ||
                               qrEndY <= centerStartY || randomY >= centerEndY);

        if (!overlapsCenter || attempts >= maxAttempts) {
          break;
        }
      } while (true);
      
      // Draw white background for QR code with border and text area
      ctx.fillStyle = 'white';
      ctx.fillRect(randomX, randomY, totalQRWidth, totalQRHeight);
      
      // Draw QR code with border offset
      ctx.drawImage(qrCanvas, randomX + borderWidth, randomY + borderWidth);
      
      // Draw logo in the center of QR code
      try {
        const logoImg = await loadImageFromUrl('https://raw.githubusercontent.com/MirageY/QR-code/main/logo1.png');
        
        // Logo size is 1/25th of QR code (1/5 width * 1/5 height = 1/25)
        const logoSize = qrSize / 4;
        const logoX = randomX + borderWidth + (qrSize - logoSize) / 2;
        const logoY = randomY + borderWidth + (qrSize - logoSize) / 2;
        
        // Draw white background circle for logo
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(logoX + logoSize/2, logoY + logoSize/2, logoSize/2 + 2, 0, 2 * Math.PI);
        ctx.fill();
        
        // Draw logo
        ctx.drawImage(logoImg, logoX, logoY, logoSize, logoSize);
      } catch (e) {
        // If logo fails to load, continue without it
        console.warn('Logo failed to load:', e);
      }
      
      // Draw text below QR code
      ctx.fillStyle = 'black';
      ctx.font = '14px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(
        label || `#${String(index).padStart(2, '0')}`, 
        randomX + totalQRWidth / 2, 
        randomY + qrSize + borderWidth * 2 + 14
      );
      
      return canvas;
    }

    function canvasToBlob(canvas){
      return new Promise(res => canvas.toBlob(res, 'image/png'));
    }

    async function generate(){
      await generateQRCodes(false);
    }

    async function generateNoBg(){
      await generateQRCodes(true);
    }

    async function generateQRCodes(noBg = false){
      const size = parseInt(el('size').value,10);
      const margin = parseInt(el('margin').value,10);
      const ecl = el('ecl').value;
      const bgImageFile = el('bgImage').files[0];
      const list = parseLines(urlsEl.value);
      gridEl.innerHTML = '';
      
      if(list.length === 0){
        statusEl.textContent = '没有检测到有效链接（确保每行一个完整 URL，如 https://example.com）。';
        return;
      }
      
      // Load background image if selected (only for non-noBg mode)
      let uploadedBackgroundImage = null;
      if (bgImageFile && !noBg) {
        try {
          statusEl.textContent = '正在加载底图...';
          uploadedBackgroundImage = await loadImageFromFile(bgImageFile);
        } catch (e) {
          statusEl.textContent = '底图加载失败：' + e.message;
          return;
        }
      }
      
      statusEl.textContent = `共 ${list.length} 条链接，开始生成${noBg ? '无底图版本' : ''}...`;

      let idx = 0;
      for (const item of list){
        idx++;
        const card = document.createElement('div');
        card.className = 'card rounded-2xl bg-white p-4 flex flex-col';
        const tag = document.createElement('div');
        tag.className = 'text-xs text-gray-500 mb-2';
        tag.textContent = item.group || `#${pad(idx,2)}`;
        card.appendChild(tag);

        const holder = document.createElement('div');
        holder.className = 'w-full flex items-center justify-center';
        
        // Load background image for this QR code (only if not noBg mode)
        let backgroundImage = null;
        if (!noBg) {
          backgroundImage = uploadedBackgroundImage;
          if (!backgroundImage) {
            try {
              const randomImageUrl = getRandomDefaultImage();
              backgroundImage = await loadImageFromUrl(randomImageUrl);
            } catch (e) {
              // If random image fails, continue without background
              backgroundImage = null;
            }
          }
        }
        
        holder.style.aspectRatio = (backgroundImage && !noBg) ? `${backgroundImage.width}/${backgroundImage.height}` : '1';
        card.appendChild(holder);

        try {
          const canvas = await makeQRCanvas(item.url, { size, margin, ecl, backgroundImage, index: idx, label: item.group, noBg });
          canvas.className = 'rounded max-w-full max-h-full';
          holder.appendChild(canvas);

          const urlTxt = document.createElement('div');
          urlTxt.className = 'mt-3 text-xs break-words text-gray-700';
          urlTxt.textContent = item.url;
          card.appendChild(urlTxt);

          const btns = document.createElement('div');
          btns.className = 'mt-3 flex gap-2';
          const btnDl = document.createElement('button');
          btnDl.className = 'flex-1 rounded-xl bg-gray-900 text-white py-2 px-3 hover:bg-black';
          btnDl.textContent = '下载 PNG';
          btnDl.onclick = async () => {
            const blob = await canvasToBlob(canvas);
            const name = `${pad(idx,2)}_${slug(item.url)}${noBg ? '_nobg' : ''}.png`;
            if (window.saveAs) saveAs(blob, name); else {
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob); a.download = name; a.click();
              setTimeout(() => URL.revokeObjectURL(a.href), 1000);
            }
          };
          const btnCopy = document.createElement('button');
          btnCopy.className = 'rounded-xl bg-gray-200 text-gray-900 py-2 px-3 hover:bg-gray-300';
          btnCopy.textContent = '复制链接';
          btnCopy.onclick = async () => { await navigator.clipboard.writeText(item.url); btnCopy.textContent='已复制'; setTimeout(()=>btnCopy.textContent='复制链接',1200); };

          btns.appendChild(btnDl);
          btns.appendChild(btnCopy);
          card.appendChild(btns);
        } catch (e){
          const err = document.createElement('div');
          err.className = 'text-red-600 text-sm mt-2';
          err.textContent = '生成失败：' + (e?.message || e);
          card.appendChild(err);
        }
        gridEl.appendChild(card);
      }
      statusEl.textContent = `已生成 ${list.length} 个${noBg ? '无底图版本' : ''}二维码。`;
    }

    async function downloadAll(){
      const cards = Array.from(gridEl.querySelectorAll('canvas'));
      if(cards.length === 0){ statusEl.textContent = '还没有可打包的二维码。'; return; }
      const zip = new JSZip();
      let i=0;
      for (const c of cards){
        i++;
        const idx = pad(i,2);
        const url = c.parentElement?.nextSibling?.textContent || `link_${idx}`;
        const name = `${idx}_${slug(url)}.png`;
        const blob = await canvasToBlob(c);
        zip.file(name, blob);
      }
      const content = await zip.generateAsync({ type: 'blob' });
      saveAs(content, `qrs_${Date.now()}.zip`);
    }

    async function downloadAllMobile(){
      const downloadButtons = Array.from(gridEl.querySelectorAll('button')).filter(btn => btn.textContent === '下载 PNG');
      if(downloadButtons.length === 0){
        statusEl.textContent = '还没有可下载的二维码。';
        return;
      }

      statusEl.textContent = `开始下载 ${downloadButtons.length} 个二维码到相册...`;

      for (let i = 0; i < downloadButtons.length; i++) {
        try {
          downloadButtons[i].click();
          statusEl.textContent = `正在下载第 ${i + 1}/${downloadButtons.length} 个二维码...`;
          // 添加短暂延迟，避免同时下载太多文件
          await new Promise(resolve => setTimeout(resolve, 500));
        } catch (e) {
          console.warn(`下载第 ${i + 1} 个二维码失败:`, e);
        }
      }

      statusEl.textContent = `已完成下载 ${downloadButtons.length} 个二维码到相册！`;
    }

    function fillSample(){
      // const demo = Array.from({length:10}, (_,i)=>`https://example.com/item-${i+1}`);
      // urlsEl.value = demo.join('\n');
      const demo = [
        "Project-Alpha",
        "① https://example.com/alpha",
        "② https://example.com/alpha/docs",
        "③ https://example.com/alpha/download",
        "",
        "Project-Beta",
        "① https://example.com/beta",
        "② https://example.com/beta/docs",
        "③ https://example.com/beta/download",
        "",
        "Project-Gamma",
        "① https://example.com/gamma",
        "② https://example.com/gamma/docs",
        "③ https://example.com/gamma/download"
      ];
      urlsEl.value = demo.join('\n');
    }

    el('btnGen').addEventListener('click', generate);
    el('btnGenNoBg').addEventListener('click', generateNoBg);
    el('btnClear').addEventListener('click', ()=>{ urlsEl.value=''; el('bgImage').value=''; gridEl.innerHTML=''; statusEl.textContent=''; });
    el('btnDownloadAll').addEventListener('click', downloadAll);
    el('btnDownloadAllMobile').addEventListener('click', downloadAllMobile);
    el('btnSample').addEventListener('click', fillSample);
  </script>
</body>
</html>
